<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      body { font: 13px Helvetica, Arial; }
      form input { border: 0; padding: 10px; width: 90%; margin-right: .5%; text-align:left;}
      form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
      #messages { list-style-type: none; margin: 0; padding: 0; }
      #messages li { padding: 5px 10px; }
      #messages li:nth-child(odd) { background: #eee; }
	  
	  .nodeChat_container {
		border: solid 1px #bbb;
		background:#53c789;
		width:600px;
		height:600px;
		margin:25px auto;
	  }
	  
	  #nodeChat_login {
		text-align:center;
		background: #ddd;
		width:100%;
		height:100%;
		padding: 45% 0;
	  }
	  #nodeChat_login form {

	  }
	  
	  #nodeChat_chatbox {
		display:none;
	  }
	  
	  #nodeChat_messages {
		height:500px;
		background: #fff;
	  }
	  
	  #nodeChat_username {
		padding:5px;
		background: #1fd173;
		color:#fff;
	  }
	  #nodeChat_username span {
		font-weight:800;
	  }
	  
	  #nodeChat_login form input,#nodeChat_chatbox form input{
		border:solid 1px #777;
	  }
    </style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script>
		var username = '';
		var loggedIn = false;
		$(document).ready(function(){		
			// User login
			$('#nodeChat_loginform').submit(function(evt){
				evt.preventDefault();
				log('login attempt');
				username = trim($('#username').val());
				log('username: ' + username);
				initChat();
			});
		});
		
		function initChat(){
			log('init chat');
			if(username != ''){
				loggedIn = true;
				$('#nodeChat_username span').html(username.toString());
				$('#nodeChat_login').fadeOut(500,function(){
					nodeChat();
					$('#nodeChat_chatbox').fadeIn(500);
				});
			}
		}
		
		function nodeChat(){
			//User Messaging
			var host = location.origin.replace(/^http/,'ws');
			log('Starting node chat ' + host);
			var ws = new WebSocket(host,'echo-protocol');	
			 
			$('#nodeChat_chatbox form').submit(function(evt){
				//sendMessage();
				if(loggedIn){
					var message = '( ' + username + ' )> ' + $('#m').val();			
					log(ws);		
					ws.send(message);
					log(message);
					$('#m').val('');
					evt.preventDefault();
					return false;
				}				
			});
			
			ws.onmessage = function(event){
				//log(event.data);
				$('#messages').append($('<li>').text(event.data));
			}
			
			ws.onclose = function(event){
				$('#nodeChat_messages').append($('<li>').text('Websocket Closed...'));
			}	
		}
		
		function trim(str){
			var pattern = /^( ){1,}|( ){1,}$/;
			return str.replace(pattern,'');
		}
		
		function log(msg){
			console.log(msg);
		}
	</script>
  </head>
  <body>
	<div class="nodeChat_container">
	
		<!-- Login form -->
		<div id="nodeChat_login">
			<form action="" id="nodeChat_loginform">
				<input id="username" /><button>Login</button>
			</form>
		</div>	
		
		<!-- Messages form -->
		<div id="nodeChat_chatbox">
			<div id="nodeChat_username">Username: <span></span></div>
			<ul id="nodeChat_messages"></ul>
			<form action="">
				<input id="m" autocomplete="off" /><button>Send</button>
			</form>
		</div>
		
	</div> <!-- /nodeChat_container -->
	

  </body>
</html>