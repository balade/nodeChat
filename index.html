<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
	<link rel="stylesheet" type="text/css" href="styles.css" />	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="functions.js"></script>
	<script>
		var username = '';
		var loggedIn = false;
		var keepalive = '';

		var host = location.origin.replace(/^http/,'ws');
		var ws = new WebSocket(host);
		log('Starting node chat ' + host);
		
		var pingRequest = '';

		$(document).ready(function(){		
			// User login
			$('#nodeChat_loginform').submit(function(evt){
				evt.preventDefault();
				username = trim($('#username').val());
				initChat();
			});
		});
		
		function initChat(){
			log('init chat');
			if(username != ''){
				// Setup once only processed items
				loggedIn = true;
				pingRequest = stringify({'type':'ping','username': username});
				
				// Setup chat box
				$('#nodeChat_username span').html(username);
				$('#nodeChat_login').fadeOut(500,function(){
					nodeChat();
					$('#nodeChat_chatbox').fadeIn(500);
				});
			}
		}
		
		function nodeChat(){
			ws.send(stringify({'type':'log request','username': username}));
			ws.send(stringify({'type':'login','username': username}));
			//Get Chat Login
			keepalive = setInterval(function(){
				ws.send(pingRequest);
			},5000);
		
			//User Messaging
			$('#nodeChat_chatbox form').submit(function(event){
				
				if(loggedIn){
					var obj = {
						'type': 'chat message',
						'username': username,
						'message':$('#m').val()
					};
				
					log(ws);		
					ws.send(stringify(obj));
					$('#m').val('');
					event.preventDefault();
					return false;
				}				
			});
			
			ws.onmessage = function(event){
				edata = parseData(event.data);
				console.log(edata.type);
				switch(edata.type){
					case 'log message':
						$('#nodeChat_messages').append($('<li>').html('<span  class="nodeChat_userlabel">' + edata.username + '</span>' + edata.message));
						break;
					case 'chat message':
						$('#nodeChat_messages').append($('<li>').html('<span  class="nodeChat_userlabel">' + edata.username + '</span>' + edata.message));
						break;
					case 'system message':
						$('#nodeChat_messages').append($('<li>').html('<span  class="nodeChat_systemlabel">System</span>' + edata.message));
						break;
				}
				
			}
			
			ws.onclose = function(event){
				$('#nodeChat_messages').append($('<li>').text('Websocket Closed...'));
				keepalive = '';
			}	
		}
	</script>
  </head>
  <body>
	<div class="nodeChat_container">
	
		<!-- Login form -->
		<div id="nodeChat_login">
			<form action="" id="nodeChat_loginform">
				<input id="username" /><button>Login</button>
			</form>
		</div>	
		
		<!-- Messages form -->
		<div id="nodeChat_chatbox">
			<div id="nodeChat_username">Username: <span></span></div>
			<ul id="nodeChat_messages"></ul>
			<form action="">
				<input id="m" autocomplete="off" /><button>Send</button>
			</form>
		</div>
		
	</div> <!-- /nodeChat_container -->
	

  </body>
</html>